{% extends "base.html" %}

{% block title %}Chatbot HUCE {% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
{% endblock %}

{% block content %}
{% if is_guest is defined and is_guest %}
<!-- Guest User Notification -->
<div class="guest-notification">
    <div class="guest-info">
        <span class="guest-icon">üë§</span>
        <span class="guest-text">B·∫°n ƒëang chat v·ªõi t∆∞ c√°ch kh√°ch.
      <a href="{{ url_for('user.login') }}" class="login-link">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ l∆∞u l·ªãch s·ª≠ chat.
    </span>
    </div>
</div>
{% endif %}

<div id="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
        <h1 class="chat-title">ü§ñ Chatbot HUCE</h1>
        <div class="chat-controls">
            <button id="info-button" class="chat-control-btn">Th√¥ng tin</button>
            <button id="reset-button" class="chat-control-btn">Reset AI</button>
        </div>
    </div>

    <!-- Chat Messages -->
    <div id="chatbox">
        {% for message in chat_history %}
        <div class="message-wrapper {{ 'user-message-wrapper' if message.sender_type == 'user' else 'bot-message-wrapper' }}">
            <div class="message {{ 'user-message' if message.sender_type == 'user' else 'bot-message' }}">
                {{ message.content | nl2br | markdown_bold | safe }}
                <span class="timestamp" data-timestamp="{{ message.timestamp.isoformat() }}">
            <script>
              document.currentScript.parentNode.textContent = new Intl.DateTimeFormat('vi-VN', {
                  hour: '2-digit',
                  minute: '2-digit',
                  timeZone: 'Asia/Ho_Chi_Minh'
              }).format(new Date('{{ message.timestamp.isoformat() }}'));
            </script>
          </span>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Chat Input -->
    <div class="chat-input-area">
        <input type="text" id="user-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
        <button id="send-button">G·ª≠i</button>
        {% if not (is_guest is defined and is_guest) %}
        <button id="new-chat-button">B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi</button>
        {% endif %}
    </div>
</div>

<!-- Modal th√¥ng tin chatbot -->
<div id="info-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ü§ñ Th√¥ng tin Chatbot HUCE</h2>
        <div id="chatbot-info">
            <p>ƒêang t·∫£i th√¥ng tin...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatbox = document.getElementById('chatbox');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const newChatButton = document.getElementById('new-chat-button');
        const infoButton = document.getElementById('info-button');
        const resetButton = document.getElementById('reset-button');
        const infoModal = document.getElementById('info-modal');
        const closeModal = document.querySelector('.close');

        // Check if user is guest
        const isGuest = {% if is_guest is defined and is_guest %}true{% else %}false{% endif %};

        // Load chatbot info on page load
        loadChatbotInfo();

        function formatTime(dateString) {
            try {
                const dateObj = new Date(dateString);
                if (isNaN(dateObj.getTime())) return "Invalid Date";
                return new Intl.DateTimeFormat('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Asia/Ho_Chi_Minh'
                }).format(dateObj);
            } catch (e) {
                return "Invalid Date";
            }
        }

        function addMessage(sender, text, timestamp) {
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper');

            if (sender === 'user') {
                wrapper.classList.add('user-message-wrapper');
            } else {
                wrapper.classList.add('bot-message-wrapper');
            }

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            if (sender === 'user') {
                messageElement.classList.add('user-message');
            } else {
                messageElement.classList.add('bot-message');
            }

            messageElement.innerHTML = sender === 'bot' ?
                text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') :
                text;

            const timestampElement = document.createElement('span');
            timestampElement.classList.add('timestamp');
            timestampElement.textContent = formatTime(timestamp);
            messageElement.appendChild(timestampElement);

            wrapper.appendChild(messageElement);
            chatbox.appendChild(wrapper);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (!messageText) return;

            const userTimestamp = new Date().toISOString();
            addMessage('user', messageText, userTimestamp);
            userInput.value = '';
            userInput.disabled = true;
            sendButton.disabled = true;
            if (newChatButton) newChatButton.disabled = true;
            sendButton.textContent = 'ƒêang x·ª≠ l√Ω...';

            try {
                const response = await fetch('{{ url_for("chat.send_message") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_input: messageText})
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: 'Ph·∫£n h·ªìi l·ªói t·ª´ m√°y ch·ªß.'}));
                    const errorMessage = errorData.error || `L·ªói t·ª´ m√°y ch·ªß (Status: ${response.status}).`;
                    console.error('Backend error:', response.status, errorMessage);
                    addMessage('bot', 'C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω tin nh·∫Øn c·ªßa b·∫°n: ' + errorMessage, new Date().toISOString());
                    return;
                }

                const data = await response.json();
                const botResponseText = data.bot_response;
                const botTimestamp = data.bot_timestamp;
                addMessage('bot', botResponseText, botTimestamp);
            } catch (error) {
                console.error('AJAX error:', error);
                addMessage('bot', 'L·ªói k·∫øt n·ªëi: Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn.', new Date().toISOString());
            } finally {
                userInput.disabled = false;
                sendButton.disabled = false;
                if (newChatButton) newChatButton.disabled = false;
                sendButton.textContent = 'G·ª≠i';
                userInput.focus();
            }
        }

        async function startNewSession() {
            if (isGuest) {
                alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o phi√™n chat m·ªõi v√† l∆∞u l·ªãch s·ª≠.');
                return;
            }

            if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi kh√¥ng?")) return;

            userInput.disabled = true;
            sendButton.disabled = true;
            newChatButton.disabled = true;
            newChatButton.textContent = 'ƒêang t·∫°o phi√™n m·ªõi...';

            try {
                const response = await fetch('{{ url_for("chat.new_session") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    alert('Phi√™n chat m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o!');
                    window.location.reload();
                } else {
                    const errorMessage = data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.';
                    alert('Kh√¥ng th·ªÉ t·∫°o phi√™n chat m·ªõi: ' + errorMessage);
                }
            } catch (error) {
                console.error('AJAX error creating new session:', error);
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·ªÉ t·∫°o phi√™n chat m·ªõi.');
            } finally {
                userInput.disabled = false;
                sendButton.disabled = false;
                newChatButton.disabled = false;
                newChatButton.textContent = 'B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi';
                userInput.focus();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });

        if (newChatButton) {
            newChatButton.addEventListener('click', startNewSession);
        }

        infoButton.addEventListener('click', showChatbotInfo);
        resetButton.addEventListener('click', resetConversation);
        closeModal.addEventListener('click', function () {
            infoModal.style.display = 'none';
        });

        window.addEventListener('click', function (event) {
            if (event.target === infoModal) {
                infoModal.style.display = 'none';
            }
        });

        // Load th√¥ng tin chatbot
        async function loadChatbotInfo() {
            try {
                const response = await fetch('{{ url_for("chat.get_chatbot_info") }}');
                if (response.ok) {
                    const info = await response.json();
                    updateChatbotInfoDisplay(info);
                }
            } catch (error) {
                console.error('Error loading chatbot info:', error);
            }
        }

        // Hi·ªÉn th·ªã modal th√¥ng tin chatbot
        async function showChatbotInfo() {
            try {
                const response = await fetch('{{ url_for("chat.get_chatbot_info") }}');
                if (response.ok) {
                    const info = await response.json();
                    updateChatbotInfoModal(info);
                    infoModal.style.display = 'block';
                } else {
                    alert('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin chatbot');
                }
            } catch (error) {
                console.error('Error getting chatbot info:', error);
                alert('L·ªói khi l·∫•y th√¥ng tin chatbot');
            }
        }

        // C·∫≠p nh·∫≠t n·ªôi dung modal
        function updateChatbotInfoModal(info) {
            const infoDiv = document.getElementById('chatbot-info');
            const features = info.features ? info.features.map(f => `<li>${f}</li>`).join('') : '';

            infoDiv.innerHTML = `
            <div class="chatbot-info-card">
                <h4>ü§ñ ${info.type || 'Unknown'}</h4>
                <p>${info.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                ${features ? `<h5>T√≠nh nƒÉng:</h5><ul>${features}</ul>` : ''}
                <div class="status-indicator ${info.type === 'Advanced RAG' ? 'advanced' : 'basic'}">
                    ${info.type === 'Advanced RAG' ? 'üöÄ N√¢ng cao' : '‚ö° C∆° b·∫£n'}
                </div>
            </div>
        `;
        }

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã tr·∫°ng th√°i chatbot
        function updateChatbotInfoDisplay(info) {
            console.log('Chatbot Type:', info.type);

            if (info.type === 'Advanced RAG') {
                document.title = 'Chatbot HUCE - Advanced AI';
            }
        }

        // Reset l·ªãch s·ª≠ h·ªôi tho·∫°i
        async function resetConversation() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën reset l·ªãch s·ª≠ h·ªôi tho·∫°i AI kh√¥ng?\n(L∆∞u √Ω: Ch·ªâ reset b·ªô nh·ªõ AI, kh√¥ng x√≥a tin nh·∫Øn tr√™n giao di·ªán)')) {
                return;
            }

            resetButton.disabled = true;
            resetButton.textContent = 'üîÑ ƒêang reset...';

            try {
                const response = await fetch('{{ url_for("chat.reset_conversation") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();
                if (response.ok && data.success) {
                    addMessage('bot', 'üîÑ ƒê√£ reset l·ªãch s·ª≠ h·ªôi tho·∫°i AI. T√¥i s·∫Ω b·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu!', new Date().toISOString());
                } else {
                    alert('Kh√¥ng th·ªÉ reset: ' + (data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                }
            } catch (error) {
                console.error('Error resetting conversation:', error);
                alert('L·ªói khi reset l·ªãch s·ª≠ h·ªôi tho·∫°i');
            } finally {
                resetButton.disabled = false;
                resetButton.textContent = 'üîÑ Reset AI';
            }
        }

    });
</script>
{% endblock %}